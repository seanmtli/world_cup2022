---
title: "christina_EDA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Introduction 

The FIFA World Cup is the most important international soccer tournament in the world, bringing in over 5 billion projected viewers across the 29 day tournament. It is held every four years and brings together the best national teams from countries around the globe to compete for the title of world champions. Not only does the world cup provide an opportunity for players to showcase their skills on the biggest stage, it also generates a huge amount of interest and excitement (and thus revenues) and also provides people from all over the world to come together and celebrate their love of soccer, and can help to foster a sense of global unity and understanding.

For a subset of the followers of the World Cup, Sports betting has become a prominent part of the experience. The sports betting industry is a large and growing market that involves people placing bets on the outcome of various sports events. This can include bets on individual games or on the overall results of a season or tournament. According to Bloomberg, a total of $35 billion will be wagered on the 2022 FIFA World Cup, a 65% increase on the previous World Cup. 

An integral part of sports betting is the usage of statistics, as it can provide valuable information about the likelihood of certain outcomes in a given game or match.By using statistics, bettors can analyze their risk, make more informed decisions about which bets to place, and have a better chance of winning and achieving profitable returns. 

In short, the goal of our project is to build a predictive model for the 2022 World Cup games using international football results and FIFA player rankings, in order to provide sports bettors valuable info about the probability specific outcomes to make informed decisions. We hope predict Goal Line (point spread/goal differential) as well as a 3 way moneyline (draw, home win, and away win) distributions. 

Our combined dataset is all international soccer matches from June 2002 to June 2021, with metrics including fifa rank, fifa points, match result, offense/defense/midfield score and more. We will first use a Poisson regression model on both home and away team scores to predict score distribution for each team respectively with a lasso penalty to choose variables and reduce collinearity. Using the relevant predictors given to us by our lasso model, we will then fit a bivariate poisson model that takes into account the dependency between home and away team goal distributions. Since we have a small number of goals, Poisson regression makes sense as it is intended for situations with few counts. Getting results that are probabilistic distributions are important in our case because sports betters are interested in the distribution of results in order to be able to quantify their risk. 


#Exploratory Data Analysis 

To start, we examine the distribution of home and away team scores in each match. The plots are right skewed, with home teams and away teams both having peaks at around 1 goal. 

```{r}
par(mfrow=c(1,2))

ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = home_team_score), binwidth = 0.5)

ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = away_team_score), binwidth = 0.5)
```


```{r}
final_dataset<- final_dataset%>%
  mutate(goal_differential = home_team_score-away_team_score,
         rank_differential =away_team_fifa_rank-home_team_fifa_rank )
```


Next, we examine the distribution of goal differentials. From this we can see that most 


```{r}
ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = goal_differential), binwidth = 0.5)
```

```{r}
ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = goal_differential), binwidth = 0.5)
```



## R Markdown

```{r}
library(tidyverse)
```

## Introduction


```{r}
matches <- read.csv("data/international_matches.csv")
box <- read.csv("data/FIFAallMatchBoxData.csv")
fifa_rankings<-read.csv("data/fifa_ranking-2022-10-06.csv")
```


```{r}
matches <- matches %>% 
  mutate(year = substr(date,1,4))

box$year <- as.character(box$year)
  

final_dataset <- inner_join(matches, box, by = c( "year"= "year",
                                            "home_team" = "hname", 
                                            "away_team" = "aname", 
                                            "home_team_score" = "hgoals", 
                                            "away_team_score" = "agoals"))

```

```{r}
final_dataset%>%
  arrange((date))
```


```{r}
ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = home_team_score), binwidth = 0.5)
```

```{r}
ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = away_team_score), binwidth = 0.5)
```
```{r}
ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = away_team_score), binwidth = 0.5)
```



```{r}
ggplot(data = final_dataset, mapping = aes(x = away_team_score, y = away_team_fifa_rank)) + 
  geom_point()
```


Top 10 FIFA ranked teams 

```{r}
home_team_ranks <- final_dataset%>%
  select(home_team,date, home_team_fifa_rank)%>%
  rename(
    team = home_team, 
    fifa_rank = home_team_fifa_rank
  )

away_team_ranks <- final_dataset%>%
  select(away_team, date, away_team_fifa_rank)%>%
  rename(
    team = away_team, 
    fifa_rank = away_team_fifa_rank
  )

team_ranks <-rbind(home_team_ranks, away_team_ranks)
  
#  merge(x=home_team_ranks,y=away_team_ranks, 
  #           by=c("team","date","fifa_rank"))
top_team_ranks<- team_ranks%>%
    arrange((team),desc(date)) %>%
    group_by(team)%>%
    slice(1) 

#%>%
 #   arrange(fifa_rank)%>% 
 #   slice(1:10)
  

fifa_top_10<-top_team_ranks%>%
  arrange(fifa_rank)%>%head(10)

fifa_top_10
```


```{r}
fifa_rankings%>%
  filter(rank_date=="2022-10-06")%>%
  arrange(rank)%>%
  slice(1:10)
```




```{r}
ggplot(data = final_dataset) +
  geom_histogram(mapping = aes(x = goal_differential), binwidth = 0.5)
```


Home team and away team rank differential vs home team rank differential

```{r}
ggplot(data = final_dataset, mapping = aes(x = goal_differential, y =rank_differential)) + 
  geom_point()
```
The greater the difference in rank (meaning the higher the home team is ranked against the away team), the higher the goal differential (the more the home team scores against the away team). 

Home team and away team rank differential vs home team result (win, draw, loss)

```{r}
ggplot(data = final_dataset, mapping = aes(x = rank_differential, y =home_team_result)) + 
   geom_boxplot()
```

Possesion vs home team result

```{r}
ggplot(data = final_dataset, mapping = aes(x = hPossesion, y =home_team_result)) + 
   geom_boxplot()
```



Best 10 offensive teams 

```{r}
home_team_offense <- final_dataset%>%
  select(home_team,date, home_team_mean_offense_score)%>%
  rename(
    team = home_team, 
    offense_score = home_team_mean_offense_score
  )

away_team_offense <- final_dataset%>%
  select(away_team, date, away_team_mean_offense_score)%>%
  rename(
    team = away_team, 
    offense_score = away_team_mean_offense_score
  )

team_offense <-rbind(home_team_offense, away_team_offense)
  
#  merge(x=home_team_ranks,y=away_team_ranks, 
  #           by=c("team","date","fifa_rank"))
top_team_offense<- team_offense%>%
    arrange((team),desc(date)) %>%
    group_by(team)%>%
    slice(1) 

top_10_offense <- top_team_offense%>%
  arrange(desc(offense_score))%>%head(10)

top_10_offense
```


Best 10 midfield teams 
```{r} 
home_team_midfield <- final_dataset%>%
  select(home_team,date, home_team_mean_midfield_score)%>%
  rename(
    team = home_team, 
    midfield_score = home_team_mean_midfield_score
  )

away_team_midfield <- final_dataset%>%
  select(away_team, date, away_team_mean_midfield_score)%>%
  rename(
    team = away_team, 
    midfield_score = away_team_mean_midfield_score
  )

team_midfield <-rbind(home_team_midfield, away_team_midfield)
  
top_team_midfield<- team_midfield%>%
    arrange((team),desc(date)) %>%
    group_by(team)%>%
    slice(1) 

top_10_midfield <- top_team_midfield%>%
  arrange(desc(midfield_score))%>%head(10)


top_10_midfield
```

Best 10 defensive teams

```{r}
home_team_defense <- final_dataset%>%
  select(home_team,date, home_team_mean_defense_score)%>%
  rename(
    team = home_team, 
    defense_score = home_team_mean_defense_score
  )

away_team_defense <- final_dataset%>%
  select(away_team, date, away_team_mean_defense_score)%>%
  rename(
    team = away_team, 
    defense_score = away_team_mean_defense_score
  )

team_defense <-rbind(home_team_defense, away_team_defense)
  
#  merge(x=home_team_ranks,y=away_team_ranks, 
  #           by=c("team","date","fifa_rank"))
top_team_defense<- team_defense%>%
    arrange((team),desc(date)) %>%
    group_by(team)%>%
    slice(1) 

top_10_defense <- top_team_defense%>%
  arrange(desc(defense_score))%>%head(10)

top_10_defense 
```


```{r}
top_10_int<- full_join(top_10_defense,top_10_midfield, by = c("team", "date"))
```

Top 10 teams for defense, midfield, and offense -- countries that have top 10 in all 3 categories will have no NA values. 

```{r}
top_10_all<-full_join(top_10_int, top_10_offense, by=c("team", "date"))
top_10_all
```

```{r}
library(reshape2)
team_scores <- melt(top_10_all, id = c("team","date"))

head(team_scores)
```


```{r}
ggplot(team_scores, aes(fill=variable, y=value, x=team)) + 
    geom_bar(position="dodge", stat="identity")+
    coord_flip()
```

Correlation Matrix 

