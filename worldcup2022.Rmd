---
title: "World Cup 2022"
author: "Sean Li, Brian Janger, Aaditya Warrier, Christina Yoh"
date: '2022-12-03'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Methodology: 
Using historical data and group stage matches individual match up to the final 16 (because we know these matchups will occur) 
Based on this data, we will calculate win probabilities, loss probabilities, and expected score 
Based on individual matches in the group stage up to round of 16, we will calculate who wins top of their group/2nd etc. 

Model: 
Use a probabilistic model, because sports betters want to know probabilities 
Poisson GLM, can use lasso
Monte Carlo 

We are predicting the goal-line (MUST BE ABSOLUTE VALUE CAUSE POISSON WILL NOT WORK OTHERWISE) for each match upto round of 16 using a Poisson GLM that takes home stats and away stats into account, as well as individual team rosters 

Will need to make two diff models for home and away because of negative value restriction

## FINAL WRITEUP

```{r}
library(tidyverse)
library(DescTools)
library(glmnet)
library(extraDistr)
data("d.countries")
source("biv-pois-functions/lm.bp.R")
source("biv-pois-functions/bivpois.table.R")
source("biv-pois-functions/newnamesbeta.R")
source("biv-pois-functions/pbivpois.R")
source("biv-pois-functions/simple.bp.R")
source("biv-pois-functions/splitbeta.R")
int_matches <- read_csv("data/international_matches.csv")
qatar_teams <- read_delim("data/Qatar2022-teams.csv", delim = ";")
matches_sched <- read_delim("data/matchs-schedule.csv", delim = ";")
final_roster_data <- read_csv("data/final_roster_data.csv")
```


```{r}
# should we use fifa only matches? we only have roster for these, still about 5000 matches including # qualifying mmatches
# fifa_only <- int_matches %>%
#   filter(str_detect(tournament, "FIFA"))

# use final_dataset from sean_eda

# setting up framework for model
test_nums <- sample 
home_x <- model.matrix(hgoals ~ . - year - hname - aname, data = box)
away_x <- model.matrix(agoals ~ . - year - hname - aname, data = box)
home_y <- box$hgoals
away_y <- box$agoals
lambda_grid <- 10^seq(-2, 10, length.out = 5000)
home_model <- cv.glmnet(home_x, home_y, alpha = 0.5, lambda = lambda_grid, family = "poisson")
away_model <- cv.glmnet(away_x, away_y, alpha = 0.5, lambda = lambda_grid, family = "poisson")

home_lambda <- home_model$lambda.min
away_lambda <- away_model$lambda.min

final_home <- glmnet(home_x, home_y, alpha = 0.5, lambda = home_lambda, family = "poisson")
final_away <- glmnet(away_x, away_y, alpha = 0.5, lambda = away_lambda, family = "poisson")

final_home$beta

final_away$beta


home_x_2022 <- placeholder # get info from int_matches dataset, use qualifying matches
away_x_2022 <- placeholder

home_preds <- predict(home_model, newdata = home_x_2022)
away_preds <- predict(away_model, newdata = home_y_2022)

goalline_preds <- home_preds - away_preds

# Monte Carlo Simulation 

# use this to generate data - https://stats.stackexchange.com/questions/27443/generate-data-samples-from-poisson-regression
fin_mod <- lm.bp(l1 = home_team_score~ home_team_fifa_rank, l2 = away_team_score~away_team_fifa_rank,
      l1l2 = ~ home_team_fifa_rank + away_team_fifa_rank, zeroL3 = TRUE, data = fifa_only)

simple.bp(x = home_y, y = away_y)



cups_only <- int_matches %>%
  filter(!str_detect(tournament, "Friendly|qualification"), format(date, "%Y") >= 2006) %>%
  select(-home_team_goalkeeper_score, away_team_goalkeeper_score)

na.omit(cups_only)

cups_only %>%
  filter(!is.na(away_team_mean_defense_score))

```

