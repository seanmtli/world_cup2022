---
title: "World Cup 2022"
author: "Sean Li, Brian Janger, Aaditya Warrier, Christina Yoh"
date: '2022-12-03'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Methodology: 
Using historical data and group stage matches individual match up to the final 16 (because we know these matchups will occur) 
Based on this data, we will calculate win probabilities, loss probabilities, and expected score 
Based on individual matches in the group stage up to round of 16, we will calculate who wins top of their group/2nd etc. 

Model: 
Use a probabilistic model, because sports betters want to know probabilities 
Poisson GLM, can use lasso
Monte Carlo 

We are predicting the goal-line (MUST BE ABSOLUTE VALUE CAUSE POISSON WILL NOT WORK OTHERWISE) for each match upto round of 16 using a Poisson GLM that takes home stats and away stats into account, as well as individual team rosters 

Will need to make two diff models for home and away because of negative value restriction

## FINAL WRITEUP

```{r}
library(tidyverse)
#library(DescTools)
library(glmnet)
library(extraDistr)
data("d.countries")
source("biv-pois-functions/lm.bp.R")
source("biv-pois-functions/bivpois.table.R")
source("biv-pois-functions/newnamesbeta.R")
source("biv-pois-functions/pbivpois.R")
source("biv-pois-functions/simple.bp.R")
source("biv-pois-functions/splitbeta.R")
int_matches <- read_csv("data/international_matches.csv")
qatar_teams <- read_delim("data/Qatar2022-teams.csv", delim = ";")
matches_sched <- read_delim("data/matchs-schedule.csv", delim = ";")
final_roster_data <- read_csv("data/final_roster_data.csv")
```


```{r}
# DECENT UNIVARIATE MODELS???
# Making new variables, keeping torunament matches only
cups_only <- int_matches %>%
  filter(!str_detect(tournament, "Friendly|qualification"), format(date, "%Y") >= 2000) %>%
  select(-home_team_goalkeeper_score, away_team_goalkeeper_score) %>%
  mutate(rank_differential = home_team_fifa_rank - away_team_fifa_rank,
         offense_differential = home_team_mean_offense_score - away_team_mean_offense_score,
         defense_differential = home_team_mean_defense_score - away_team_mean_defense_score,
         midfield_differential = home_team_mean_midfield_score - away_team_mean_midfield_score,
         points_differential = home_team_total_fifa_points - away_team_total_fifa_points,
         year = as.numeric(format(date, "%Y"))) 
# %>%
#   filter(tournament == "FIFA World Cup")

# Summarizing roster data 
sum_roster <- final_roster_data %>%
  mutate(Country =
           case_when(Country == "South Korea" ~ "Korea Republic",
                     Country == "United States" ~ "USA",
                     Country == "Iran" ~ "IR Iran",
                     Country == "Ivory Coast" ~ "CÃ´te d'Ivoire",
                     Country == "North Korea" ~ "Korea DPR",
                     TRUE ~  Country)) %>%
  group_by(Country, year) %>%
  summarize(median_caps_home = mean(as.numeric(Caps), na.rm = TRUE))

roster_away <- sum_roster %>%
  rename(median_caps_away = median_caps_home)

# This merges roster data - must adds caps_differential to all models if using ------------------

# cups_only <- left_join(cups_only, sum_roster, by = c("year" = "year",
#                                               "home_team" = "Country")) %>%
#   left_join(roster_away, by = c("year" = "year",
#                                               "away_team" = "Country")) %>%
#   mutate(caps_differential = median_caps_home - median_caps_away)

# ----------------------------------------------------------------------------------------------

# Fitting UNIVARIATE models --------------------------------------------------------------------

# Building train and test set for CV
set.seed(2)
cups_only_nona <- na.omit(cups_only)
n <- nrow(cups_only_nona)
train_nums <- sample(1:n, size = 0.8*n)


test_data = cups_only_nona[-train_nums, ] %>%
  select(rank_differential, offense_differential, defense_differential, midfield_differential,
         points_differential, neutral_location, shoot_out) # add cap_diff if using

mat = model.matrix(~., test_data)

test_home <- cups_only_nona[-train_nums, "home_team_score"] %>%
  pull()
test_away <- cups_only_nona[-train_nums, "away_team_score"] %>% 
  pull()

train_data <- cups_only_nona[train_nums, ]


# Model equations 
home_x <- model.matrix(home_team_score ~ rank_differential + offense_differential + 
                         defense_differential + midfield_differential + 
         points_differential + neutral_location + shoot_out, 
                       data = train_data) # add cap_diff if using
away_x <- model.matrix(away_team_score ~  + rank_differential + offense_differential + 
                         defense_differential + midfield_differential + 
         points_differential + neutral_location + shoot_out, 
                       data = train_data) # add cap_diff if using

home_y <- train_data$home_team_score
away_y <- train_data$away_team_score


# Cross validating 
lambda_grid <- 10^seq(-2, 10, length.out = 5000)
home_model <- cv.glmnet(home_x, home_y, alpha = 1, lambda = lambda_grid, family = "poisson",
                        nfolds = 5)
away_model <- cv.glmnet(away_x, away_y, alpha = 1, lambda = lambda_grid, family = "poisson", 
                        nfolds = 5)

home_lambda <- home_model$lambda.min
away_lambda <- away_model$lambda.min


# Fitting final models

final_home <- glmnet(home_x, home_y, alpha = 1, lambda = home_lambda, family = "poisson")
final_away <- glmnet(away_x, away_y, alpha = 1, lambda = away_lambda, family = "poisson")

final_home$beta
final_away$beta

# Generating preds
home_preds <- predict(home_model, newx = mat, type = "response")
away_preds <- predict(away_model, newx = mat, type = "response")
```


```{r checking}
# SANITY CHECKS FOR ACCURACY
sqrt(mean((test_home - home_preds)^2))
sqrt(mean((test_away - away_preds)^2))

median(abs(test_home - home_preds))
median(abs(test_away - away_preds))


goalline_preds <- home_preds - away_preds

outcomes <- na.omit(cups_only)[-train_nums, "home_team_result"] 

outcomes %>%
  count(home_team_result)

sum(goalline_preds  <0)
```


```{r FINAL BIVPOIS MODEL, warning=FALSE}
biv_cups_only_nona <- cups_only_nona %>%
  mutate(shoot_out = ifelse(shoot_out == "Yes", 1, 0),
         neutral_location = ifelse(neutral_location == TRUE, 1, 0))

# need to test accuracy still of bivpoiss with train-test - looks p decent though
set.seed(2)
n <- nrow(biv_cups_only_nona)
train_nums <- sample(1:n, size = 0.8*n)


fin_mod <- lm.bp(l1 = home_team_score~ rank_differential + points_differential, 
                 l2 = away_team_score~ rank_differential + offense_differential + 
                   points_differential + neutral_location + shoot_out,
                 l3 = ~rank_differential + points_differential, 
                 data = biv_cups_only_nona)

final_roster_data %>%
  group_by(Country, year) %>%
  summarize(mean_caps = median(as.numeric(Caps), na.rm = TRUE))
```

```{r monte carlo}

# Monte Carlo Simulation 

# use this to generate data - https://stats.stackexchange.com/questions/27443/generate-data-samples-from-poisson-regression
```

